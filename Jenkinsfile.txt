
node() {
    def jenkinsCredentialsId = 'MyGitHub'
    def commonBranchName = ''

    //First, check out the application project
    dir('Sample') {
        checkout scm

        //Now we need to know if env.BRANCH_NAME is actually a branch name or a PR number. We use the hub command to find out
        //if BRANCH_NAME is a known PR. If it is, we ask hub to give us the corresponding branch name, otherwise, we treat
        //BRANCH_NAME as if it really is the name of the branch.

        withEnv(['PATH+EXTRA=/usr/local/bin']) {
            commonBranchName = sh(returnStdout: true, script:'./getCommonBranchName.sh ${BRANCH_NAME}')
        }
    }

    dir('Sample'){
        def currentStage = "NOT STARTED";

        try {
            stage('Source Validation') {
                sh './validateSource.sh'
            }

            stage('Build') {
                currentStage = 'Build - Refresh and Clean';
                if (env.BRANCH_NAME == 'develop' || env.BRANCH_NAME == 'MOB-6109') {
                    sh './gradlew --refresh-dependencies clean assembleAuto assembleStage'
                }
                else {
                    sh './gradlew --refresh-dependencies clean assembleAuto assembleRelease'
                }
            }


         //   stage('Sign'){
           //     currentStage = 'Sign';
             //   if (env.BRANCH_NAME == 'master' || env.BRANCH_NAME == 'develop' || env.BRANCH_NAME == 'MOB-6109') {
               //     signAndroidApks keyStoreId: "AndroidBuildKey", keyAlias: "", apksToSign: "**/*-unsigned.apk"
                //}
           // }

       //       stage('Sign'){
         //     currentStage = 'Sign';
           //       withCredentials([string(credentialsId: 'keystorepass', variable: 'KEY_PASSWORD'),file(credentialsId: 'keystorefile', variable: 'KEYSTORE')])
             //     {
               //    sh '/c/Users/global/AppData/Local/Android/Sdk/build-tools/29.0.3/zipalign -v -p 4 /C/CustomJenkinsSpace/Jenkins/.jenkins/workspace/QAPipeline_MOB-6109/android-FrontlineMobile/app/build/outputs/apk/stage/app-*-unsigned.apk /C/CustomJenkinsSpace/Jenkins/.jenkins/workspace/QAPipeline_MOB-6109/android-FrontlineMobile/app/build/outputs/apk/stage/unsigned-aligned.apk'
                 //  sh '/c/Users/global/AppData/Local/Android/Sdk/build-tools/29.0.3/apksigner.bat sign --ks $KEYSTORE --ks-pass pass:$KEY_PASSWORD --out /D/MyJenkinsApks/FLMobile/stage/fl_signed.apk /C/CustomJenkinsSpace/Jenkins/.jenkins/workspace/QAPipeline_MOB-6109/android-FrontlineMobile/app/build/outputs/apk/stage/unsigned-aligned.apk'
                   //}
               // currentBuild.result = 'SUCCESS'
             //}

           
              stage("Deployment"){
              if(env.result == 'SUCCESS'){
              sh 'echo "Started with the Deployment process"'
              }
              }
        }
        catch(error) {
            currentBuild.result = 'FAILURE'
            throw new hudson.AbortException(error.toString());
        }
    }
}
